<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Turni Collaboratori</title>
  
  <!-- Librerie Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Libreria jsPDF per esportazione PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      font-size: 24px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    #shift-table th, #shift-table td {
      padding: 2px 4px;
      font-size: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }

    /* Righe zebrate */
    #shift-table tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    #shift-table tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #summary-table th, #summary-table td {
      padding: 6px;
      text-align: center;
      border: 1px solid #ddd;
    }

    button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
      border-radius: 5px;
    }

    button:hover {
      background-color: #0056b3;
    }

    input, select {
      padding: 8px;
      margin: 5px 0;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    #signature-pad {
      margin-top: 10px;
      border: 1px solid black;
    }

  </style>
</head>

<body>

<h1>Gestione Turni Collaboratori</h1>

<!-- Sezione Login -->
<div id="login-section">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Accedi</button>
  <p><a href="#" onclick="showResetPassword()">Password dimenticata?</a></p>
  
  <div id="reset-section" style="display:none;">
    <input type="email" id="resetEmail" placeholder="Inserisci la tua email">
    <button onclick="sendPasswordReset()">Invia Email di Reset</button>
  </div>
</div>

<!-- Sezione Turni -->
<div id="shift-section" style="display:none;">

  <!-- Filtro Data -->
  <select id="dateFilter" onchange="loadShifts()">
    <option value="oldest">Dal più vecchio</option>
    <option value="newest">Dal più recente</option>
  </select>

  <!-- Tabella Turni -->
  <table id="shift-table">
    <thead>
      <tr>
        <th>Data</th>
        <th>Ora Inizio</th>
        <th>Ora Fine</th>
        <th>Mansione</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody>
      <!-- Turni caricati dinamicamente -->
    </tbody>
  </table>

  <!-- Riepilogo Ore -->
  <h3>Ore Lavorate per Mansione</h3>
  <table id="summary-table">
    <thead>
      <tr>
        <th>Mansione</th>
        <th>Ore Totali</th>
      </tr>
    </thead>
    <tbody>
      <!-- Riepilogo dinamico -->
    </tbody>
  </table>

  <!-- Sezione Firma -->
  <h3>Firma Collaboratore</h3>
  <canvas id="signature-pad" width="300" height="100"></canvas>
  <br>
  <button onclick="clearSignature()">Pulisci Firma</button>

  <!-- Pulsante Esporta PDF -->
  <button onclick="exportPDF()">Esporta Foglio Ore in PDF</button>

</div>

// --- CONFIGURAZIONE FIREBASE ---
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCfhZ4n_uFbgtcmMHesx1rswTZaUuhgwcQ",
  authDomain: "gestione-turni-50fc4.firebaseapp.com",
  databaseURL: "https://gestione-turni-50fc4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gestione-turni-50fc4",
  storageBucket: "gestione-turni-50fc4.appspot.com",
  messagingSenderId: "1067061975120",
  appId: "1:1067061975120:web:8ccfb053119c3d15329955",
  measurementId: "G-Y19TG637V9"
};

// Inizializzazione Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// Variabili globali
let currentUser = null;
let fullName = "";
let canvas = document.getElementById('signature-pad');
let ctx = canvas.getContext('2d');

// --- LOGIN ---
function login() {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();

  auth.signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      currentUser = userCredential.user;
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('shift-section').style.display = 'block';
      loadShifts();
      askFullName();
    })
    .catch(error => {
      alert(error.message);
    });
}

// --- RESET PASSWORD ---
function showResetPassword() {
  document.getElementById('reset-section').style.display = 'block';
}

function sendPasswordReset() {
  const email = document.getElementById('resetEmail').value.trim();
  auth.sendPasswordResetEmail(email)
    .then(() => {
      alert("Email di reset inviata!");
    })
    .catch(error => {
      alert(error.message);
    });
}

// --- FIRMA PAD ---
function clearSignature() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// --- NOME E COGNOME ---
function askFullName() {
  if (!localStorage.getItem('fullName')) {
    fullName = prompt("Inserisci il tuo nome e cognome:");
    localStorage.setItem('fullName', fullName);
  } else {
    fullName = localStorage.getItem('fullName');
  }
}

// --- AGGIUNTA TURNO ---
function addShift(date, start, end, role) {
  const shiftsRef = database.ref('shifts/' + currentUser.uid);
  const newShiftRef = shiftsRef.push();
  newShiftRef.set({
    date: date,
    start: start,
    end: end,
    role: role
  });
}

// --- CARICA TURNI ---
function loadShifts() {
  const tbody = document.querySelector('#shift-table tbody');
  tbody.innerHTML = '';

  const order = document.getElementById('dateFilter').value;
  const shiftsRef = database.ref('shifts/' + currentUser.uid);

  shiftsRef.orderByChild('date').once('value', snapshot => {
    let shifts = [];
    snapshot.forEach(childSnapshot => {
      shifts.push({ key: childSnapshot.key, ...childSnapshot.val() });
    });

    if (order === 'newest') shifts.reverse();

    shifts.forEach(shift => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${shift.date}</td>
        <td>${shift.start}</td>
        <td>${shift.end}</td>
        <td>${shift.role}</td>
        <td>
          <button onclick="editShift('${shift.key}', '${shift.date}', '${shift.start}', '${shift.end}', '${shift.role}')">Modifica</button>
          <button onclick="deleteShift('${shift.key}')">Elimina</button>
        </td>
      `;
      tbody.appendChild(row);
    });

    updateSummaryTable(shifts);
  });
}

// --- MODIFICA TURNO ---
function editShift(key, oldDate, oldStart, oldEnd, oldRole) {
  const newDate = prompt("Nuova Data:", oldDate) || oldDate;
  const newStart = prompt("Nuova Ora Inizio:", oldStart) || oldStart;
  const newEnd = prompt("Nuova Ora Fine:", oldEnd) || oldEnd;
  const newRole = prompt("Nuova Mansione:", oldRole) || oldRole;

  database.ref('shifts/' + currentUser.uid + '/' + key).update({
    date: newDate,
    start: newStart,
    end: newEnd,
    role: newRole
  }).then(() => {
    loadShifts();
  });
}

// --- CANCELLA TURNO ---
function deleteShift(key) {
  if (confirm('Sei sicuro di voler eliminare questo turno?')) {
    database.ref('shifts/' + currentUser.uid + '/' + key).remove()
      .then(() => {
        loadShifts();
      });
  }
}

// --- RIEPILOGO ORE PER MANSIONE ---
function updateSummaryTable(shifts) {
  const summary = {};

  shifts.forEach(shift => {
    const start = shift.start.split(':').map(Number);
    const end = shift.end.split(':').map(Number);
    let diff = (end[0] * 60 + end[1]) - (start[0] * 60 + start[1]);
    if (diff < 0) diff += 24 * 60;
    const hours = diff / 60;

    if (!summary[shift.role]) summary[shift.role] = 0;
    summary[shift.role] += hours;
  });

  const tbody = document.querySelector('#summary-table tbody');
  tbody.innerHTML = '';

  for (const role in summary) {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${role}</td><td>${summary[role].toFixed(2)}h</td>`;
    tbody.appendChild(row);
  }
}

// --- EXPORT PDF ---
async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'landscape',
    unit: 'mm',
    format: 'a4'
  });

  // Header Titoli
  doc.setFontSize(14);
  doc.text('CENTRO FIN LAMPUGNANO', 40, 15);
  const now = new Date();
  const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno",
                      "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
  const month = monthNames[now.getMonth()];
  const year = now.getFullYear();
  doc.text(`FOGLIO ORE DI ${month.toUpperCase()} ${year}`, 40, 25);
  doc.text(fullName, 40, 35);

  // Tabella setup
  let startY = 50;
  const startX = 5;
  const firstColWidth = 25; // Colonna Data
  const colWidth = 22;       // Colonne mansioni
  const fontSize = 5.5;
  doc.setFontSize(fontSize);

  const shiftsByDateRole = {};
  const rows = document.querySelectorAll('#shift-table tbody tr');
  if (rows.length === 0) {
    alert("Nessun turno da esportare!");
    return;
  }

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const date = new Date(cells[0].innerText);
    const day = date.getDate();
    const role = cells[3].innerText;
    const start = cells[1].innerText;
    const end = cells[2].innerText;

    if (!shiftsByDateRole[day]) shiftsByDateRole[day] = {};
    shiftsByDateRole[day][role] = { start, end };
  });

  const allRoles = new Set();
  rows.forEach(row => {
    const role = row.querySelectorAll('td')[3].innerText;
    allRoles.add(role);
  });

  const roleList = Array.from(allRoles);

  // Scrive intestazioni
  doc.text('Data', startX + 2, startY);
  roleList.forEach((role, idx) => {
    const roleX = startX + firstColWidth + idx * colWidth;
    const parts = role.split(' ');
    const firstLine = parts.slice(0, -1).join(' ') || role;
    const secondLine = parts.length > 1 ? parts.slice(-1)[0] : '';

    doc.text(firstLine, roleX + 1, startY);
    if (secondLine) {
      doc.text(secondLine, roleX + 1, startY + 3.5);
    }
  });

  const totalWidth = firstColWidth + colWidth * roleList.length;
  let lineStartY = startY - 5;
  let lineEndY = startY + 165;

  // Linee verticali
  doc.setLineWidth(0.1);
  doc.line(startX, lineStartY, startX, lineEndY);
  doc.line(startX + firstColWidth, lineStartY, startX + firstColWidth, lineEndY);
  roleList.forEach((role, idx) => {
    const x = startX + firstColWidth + (idx + 1) * colWidth;
    doc.line(x, lineStartY, x, lineEndY);
  });

  startY += 9;

  const totalHoursByRole = {};

  for (let day = 1; day <= 31; day++) {
    if (startY > 190) {
      doc.addPage();
      startY = 20;
      doc.setFontSize(fontSize);
    }

    doc.text(day.toString(), startX + 2, startY);

    roleList.forEach((role, idx) => {
      const shift = shiftsByDateRole[day] ? shiftsByDateRole[day][role] : null;
      if (shift) {
        const shiftText = `${shift.start}-${shift.end}`;
        doc.text(shiftText, startX + firstColWidth + idx * colWidth + 2, startY);

        const [sh, sm] = shift.start.split(':').map(Number);
        const [eh, em] = shift.end.split(':').map(Number);
        let diff = (eh * 60 + em) - (sh * 60 + sm);
        if (diff < 0) diff += 24 * 60;
        const hours = diff / 60;

        if (!totalHoursByRole[role]) totalHoursByRole[role] = 0;
        totalHoursByRole[role] += hours;
      }
    });

    // Linea orizzontale dopo ogni giorno
    doc.line(startX, startY + 1.5, startX + totalWidth, startY + 1.5);

    startY += 4.5;
  }

  // Riga Totali
  startY += 3;
  doc.setFontSize(6);
  doc.text('Totali', startX + 2, startY);

  roleList.forEach((role, idx) => {
    const total = totalHoursByRole[role] ? totalHoursByRole[role].toFixed(2) + 'h' : '';
    doc.text(total, startX + firstColWidth + idx * colWidth + 2, startY);
  });

  // Firma Collaboratore
  startY += 12;
  doc.setFontSize(10);
  doc.text("Firma Collaboratore:", 10, startY);
  startY += 5;

  const signatureImage = canvas.toDataURL("image/png");
  doc.addImage(signatureImage, 'PNG', 10, startY, 80, 30);

  // Nome file dinamico
  const userCleanName = firebase.auth().currentUser.email.split('@')[0].replace(/[\W_]+/g, '');
  const fileName = `FoglioOre_${userCleanName}_${month}${year}.pdf`;

  doc.save(fileName);
}

</body>
</html>
