<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Turni Collaboratori</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase Core SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    #login-form, #shift-section {
      max-width: 600px;
      margin: 0 auto;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #cccccc;
      padding: 8px;
      text-align: center;
    }
    #error-message, #password-message, #reset-message {
      color: red;
      margin-top: 10px;
    }
    details summary {
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
    }
    .summary-table {
      margin-top: 30px;
      text-align: left;
    }
  </style>
</head>

<body>
<h1>Gestione Turni Collaboratori</h1>

<!-- Login Form -->
<div id="login-form">
  <h2>Accedi</h2>
  <input type="email" id="username" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Accedi</button>
  <div id="error-message"></div>

  <div id="reset-password-section" style="margin-top: 30px;">
    <h3>Password dimenticata?</h3>
    <input type="email" id="reset-email" placeholder="Inserisci la tua email">
    <button onclick="sendResetEmail()">Invia Email di Reset</button>
    <div id="reset-message"></div>
  </div>
</div>

<!-- Shift Section -->
<div id="shift-section" style="display:none;">
  <h2>Benvenuto, <span id="user-name"></span>!</h2>

  <div class="form-group">
    <label for="date">Data</label>
    <input type="date" id="date">
  </div>
  <div class="form-group">
    <label for="start-time">Ora Inizio</label>
    <input type="time" id="start-time">
  </div>
  <div class="form-group">
    <label for="end-time">Ora Fine</label>
    <input type="time" id="end-time">
  </div>
  <div class="form-group">
    <label for="role">Mansione</label>
    <select id="role"></select>
  </div>

  <button onclick="addShift()">Aggiungi / Salva Modifica</button>
  <button onclick="logout()" style="background-color: red; color: white;">Logout</button>

  <!-- Filtro per data -->
  <div style="margin-top:20px;">
    <h3>Filtra Turni per Data</h3>
    <label for="start-date">Data Inizio</label>
    <input type="date" id="start-date" onchange="loadShifts()">
    <label for="end-date">Data Fine</label>
    <input type="date" id="end-date" onchange="loadShifts()">
  </div>

  <!-- Filtro Ordinamento -->
  <div style="margin-top:20px;">
    <h3>Ordinamento Turni</h3>
    <select id="sort-order" onchange="loadShifts()">
      <option value="asc">Dal più vecchio</option>
      <option value="desc">Dal più recente</option>
    </select>
  </div>

  <table id="shift-table">
    <thead>
      <tr>
        <th>Data</th>
        <th>Ora Inizio</th>
        <th>Ora Fine</th>
        <th>Mansione</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Riepilogo Ore -->
  <div class="summary-table">
    <h3>Ore Lavorate per Mansione</h3>
    <table id="summary-table">
      <thead>
        <tr><th>Mansione</th><th>Ore Totali</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <details>
    <summary>Cambia la tua password</summary>
    <div style="margin-top: 10px;">
      <input type="password" id="old-password" placeholder="Vecchia Password">
      <input type="password" id="new-password" placeholder="Nuova Password">
      <button onclick="changePassword()">Conferma Cambio Password</button>
      <div id="password-message"></div>
    </div>
  </details>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCfhZ4n_uFbgtcmMHesx1rswTZaUuhgwcQ",
  authDomain: "gestione-turni-50fc4.firebaseapp.com",
  databaseURL: "https://gestione-turni-50fc4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gestione-turni-50fc4",
  storageBucket: "gestione-turni-50fc4.appspot.com",
  messagingSenderId: "1067061975120",
  appId: "1:1067061975120:web:8ccfb053119c3d15329955",
  measurementId: "G-Y19TG637V9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

let currentUser = "";
let editingShiftId = null;
const shiftTableBody = document.querySelector('#shift-table tbody');
const summaryTableBody = document.querySelector('#summary-table tbody');
const roleSelect = document.getElementById('role');

const mansions = [
  "Assistente bagnanti FERIALE", "Assistente bagnanti FESTIVO",
  "Cassa FERIALE", "Cassa FESTIVO", "Rotazione FERIALE", "Rotazione FESTIVO",
  "Istruttore FERIALE", "Istruttore FESTIVO", "Aiuto allenatore FERIALE", "Aiuto allenatore FESTIVO",
  "Sincro/Pallan FERIALE", "Sincro/Pallan FESTIVO", "Acquagym FERIALE", "Acquagym FESTIVO",
  "Baby istruttore FERIALE", "Baby istruttore FESTIVO", "Baby aiuto allenatore FERIALE", "Baby aiuto allenatore FESTIVO",
  "Neonatale FERIALE", "Neonatale FESTIVO", "Preparto FERIALE", "Preparto FESTIVO",
  "Lezione individuale FERIALE", "Lezione individuale FESTIVO", "Propaganda FERIALE", "Propaganda FESTIVO",
  "Segreteria FERIALE", "Segreteria FESTIVO", "Coordinatore FERIALE", "Coordinatore FESTIVO",
  "Aquagol/Salvamento FERIALE", "Aquagol/Salvamento FESTIVO"
];
mansions.forEach(role => {
  const option = document.createElement('option');
  option.value = role;
  option.textContent = role;
  roleSelect.appendChild(option);
});

function login() {
  const email = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  auth.signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('shift-section').style.display = 'block';
      document.getElementById('user-name').innerText = userCredential.user.email;
      currentUser = userCredential.user.email.replace(/[.#$\[\]]/g, '_');
      loadShifts();
    })
    .catch(() => {
      document.getElementById('error-message').innerText = "Credenziali errate. Riprova.";
    });
}

function logout() {
  auth.signOut().then(() => location.reload());
}

function addShift() {
  const date = document.getElementById('date').value;
  const startTime = document.getElementById('start-time').value;
  const endTime = document.getElementById('end-time').value;
  const role = document.getElementById('role').value;
  if (!date || !startTime || !endTime || !role) return alert('Compila tutti i campi!');

  const shift = { date, startTime, endTime, role };
  if (editingShiftId) {
    database.ref('shifts/' + currentUser + '/' + editingShiftId).set(shift).then(() => {
      editingShiftId = null;
      clearForm();
      loadShifts();
    });
  } else {
    const shiftId = database.ref().child('shifts').push().key;
    database.ref('shifts/' + currentUser + '/' + shiftId).set(shift).then(() => {
      clearForm();
      loadShifts();
    });
  }
}

function clearForm() {
  document.getElementById('date').value = '';
  document.getElementById('start-time').value = '';
  document.getElementById('end-time').value = '';
  document.getElementById('role').value = '';
}

function loadShifts() {
  shiftTableBody.innerHTML = '';
  summaryTableBody.innerHTML = '';
  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  const sortOrder = document.getElementById('sort-order').value;

  database.ref('shifts/' + currentUser).once('value').then(snapshot => {
    let shifts = snapshot.val();
    if (shifts) {
      let shiftsArray = Object.entries(shifts).map(([id, shift]) => ({ id, ...shift }));
      if (startDate) shiftsArray = shiftsArray.filter(shift => new Date(shift.date) >= new Date(startDate));
      if (endDate) shiftsArray = shiftsArray.filter(shift => new Date(shift.date) <= new Date(endDate));
      shiftsArray.sort((a, b) => sortOrder === 'asc' ? new Date(a.date) - new Date(b.date) : new Date(b.date) - new Date(a.date));

      const hoursByRole = {};
      shiftsArray.forEach(shift => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${shift.date}</td>
          <td>${shift.startTime}</td>
          <td>${shift.endTime}</td>
          <td>${shift.role}</td>
          <td>
            <button onclick="editShift('${shift.id}')">Modifica</button>
            <button onclick="deleteShift('${shift.id}')" style="background-color:red;color:white;">Elimina</button>
          </td>`;
        shiftTableBody.appendChild(row);

        const start = parseTime(shift.startTime);
        const end = parseTime(shift.endTime);
        let diffHours = (end - start) / (1000 * 60 * 60);
        if (diffHours < 0) diffHours += 24;
        if (!hoursByRole[shift.role]) hoursByRole[shift.role] = 0;
        hoursByRole[shift.role] += diffHours;
      });

      for (const role in hoursByRole) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${role}</td><td>${hoursByRole[role].toFixed(2)} ore</td>`;
        summaryTableBody.appendChild(row);
      }
    }
  });
}

function parseTime(timeStr) {
  const [hours, minutes] = timeStr.split(":").map(Number);
  const date = new Date();
  date.setHours(hours, minutes, 0, 0);
  return date;
}

function editShift(id) {
  database.ref('shifts/' + currentUser + '/' + id).once('value').then(snapshot => {
    const shift = snapshot.val();
    if (shift) {
      document.getElementById('date').value = shift.date;
      document.getElementById('start-time').value = shift.startTime;
      document.getElementById('end-time').value = shift.endTime;
      document.getElementById('role').value = shift.role;
      editingShiftId = id;
    }
  });
}

function deleteShift(id) {
  if (confirm("Sei sicuro di voler eliminare questo turno?")) {
    database.ref('shifts/' + currentUser + '/' + id).remove().then(() => loadShifts());
  }
}

function sendResetEmail() {
  const email = document.getElementById('reset-email').value.trim();
  firebase.auth().sendPasswordResetEmail(email)
    .then(() => document.getElementById('reset-message').innerText = "Email inviata!")
    .catch(error => document.getElementById('reset-message').innerText = error.message);
}

function changePassword() {
  const user = firebase.auth().currentUser;
  const oldPassword = document.getElementById('old-password').value.trim();
  const newPassword = document.getElementById('new-password').value.trim();
  const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPassword);

  user.reauthenticateWithCredential(credential)
    .then(() => user.updatePassword(newPassword).then(() => {
      document.getElementById('password-message').innerText = "Password cambiata!";
    }))
    .catch(error => document.getElementById('password-message').innerText = "Errore: " + error.message);
}
</script>

</body>
</html>
