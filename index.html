<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Turni Collaboratori</title>
  
  <!-- Librerie Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Libreria jsPDF per esportazione PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      font-size: 24px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    #shift-table th, #shift-table td {
      padding: 2px 4px;
      font-size: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }

    /* Righe zebrate */
    #shift-table tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    #shift-table tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #summary-table th, #summary-table td {
      padding: 6px;
      text-align: center;
      border: 1px solid #ddd;
    }

    button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
      border-radius: 5px;
    }

    button:hover {
      background-color: #0056b3;
    }

    input, select {
      padding: 8px;
      margin: 5px 0;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    #signature-pad {
      margin-top: 10px;
      border: 1px solid black;
    }

  </style>
</head>

<body>
  
<h1>Gestione Turni Collaboratori</h1>

<!-- Login Form -->
<div id="login-form">
  <h2>Accedi</h2>
  <input type="email" id="username" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Accedi</button>
  <div id="error-message"></div>

  <div id="reset-password-section" style="margin-top: 30px;">
    <h3>Password dimenticata?</h3>
    <input type="email" id="reset-email" placeholder="Inserisci la tua email">
    <button onclick="sendResetEmail()">Invia Email di Reset</button>
    <div id="reset-message"></div>
  </div>
</div>

<!-- Area Turni -->
<div id="shift-section" style="display:none;">
  <h2>Benvenuto, <span id="user-name"></span>!</h2>

  <!-- Nome e Cognome -->
  <div id="name-form">
    <h3>Inserisci Nome e Cognome</h3>
    <input type="text" id="full-name" placeholder="Nome e Cognome">
    <button onclick="saveName()">Conferma Nome</button>
  </div>

  <div id="shift-content" style="display:none;">
    <input type="date" id="date">
    <input type="time" id="start-time">
    <input type="time" id="end-time">
    <select id="role"></select>

    <button onclick="addShift()">Aggiungi / Salva Modifica</button>
    <button onclick="logout()" style="background-color: red; color: white;">Logout</button>

    <h3>Filtri Turni</h3>
    <select id="filter-role" onchange="loadShifts()">
      <option value="">Tutte le mansioni</option>
    </select>
    <input type="date" id="start-date" onchange="loadShifts()">
    <input type="date" id="end-date" onchange="loadShifts()">
    <select id="sort-order" onchange="loadShifts()">
      <option value="asc">Dal pi√π vecchio</option>
      <option value="desc">Dal pi√π recente</option>
    </select>

    <table id="shift-table">
      <thead>
        <tr><th>Data</th><th>Ora Inizio</th><th>Ora Fine</th><th>Mansione</th><th>Azioni</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="summary-table">
      <h3>Ore Lavorate per Mansione</h3>
      <table id="summary-table">
        <thead><tr><th>Mansione</th><th>Ore Totali</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <h3>Firma Collaboratore</h3>
    <canvas id="signature-canvas" width="500" height="100" style="border: 2px solid #000; border-radius: 4px;"></canvas><br>
    <button onclick="clearSignature()" style="margin-top: 10px;">Pulisci Firma</button>
    <button onclick="exportPDF()" style="margin-top: 20px;">Esporta Foglio Ore in PDF</button>

    <details>
      <summary>Cambia la tua password</summary>
      <input type="password" id="old-password" placeholder="Vecchia Password">
      <input type="password" id="new-password" placeholder="Nuova Password">
      <button onclick="changePassword()">Conferma Cambio Password</button>
      <div id="password-message"></div>
    </details>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCfhZ4n_uFbgtcmMHesx1rswTZaUuhgwcQ",
  authDomain: "gestione-turni-50fc4.firebaseapp.com",
  databaseURL: "https://gestione-turni-50fc4-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "gestione-turni-50fc4",
  storageBucket: "gestione-turni-50fc4.appspot.com",
  messagingSenderId: "1067061975120",
  appId: "1:1067061975120:web:8ccfb053119c3d15329955",
  measurementId: "G-Y19TG637V9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

let currentUser = "";
let fullName = "";
let editingShiftId = null;

const shiftTableBody = document.querySelector('#shift-table tbody');
const summaryTableBody = document.querySelector('#summary-table tbody');
const roleSelect = document.getElementById('role');
const filterRoleSelect = document.getElementById('filter-role');
const canvas = document.getElementById('signature-canvas');
const ctx = canvas.getContext('2d');
let drawing = false;

// Lista mansioni
const mansions = [
  "Assistente bagnanti FERIALE", "Assistente bagnanti FESTIVO", "Cassa FERIALE", "Cassa FESTIVO",
  "Rotazione FERIALE", "Rotazione FESTIVO", "Istruttore FERIALE", "Istruttore FESTIVO",
  "Aiuto allenatore FERIALE", "Aiuto allenatore FESTIVO", "Sincro/Pallan FERIALE", "Sincro/Pallan FESTIVO",
  "Acquagym FERIALE", "Acquagym FESTIVO", "Baby istruttore FERIALE", "Baby istruttore FESTIVO",
  "Baby aiuto allenatore FERIALE", "Baby aiuto allenatore FESTIVO", "Neonatale FERIALE", "Neonatale FESTIVO",
  "Preparto FERIALE", "Preparto FESTIVO", "Lezione individuale FERIALE", "Lezione individuale FESTIVO",
  "Propaganda FERIALE", "Propaganda FESTIVO", "Segreteria FERIALE", "Segreteria FESTIVO",
  "Coordinatore FERIALE", "Coordinatore FESTIVO", "Aquagol/Salvamento FERIALE", "Aquagol/Salvamento FESTIVO"
];

mansions.forEach(role => {
  const option = document.createElement('option');
  option.value = role;
  option.textContent = role;
  roleSelect.appendChild(option);

  const option2 = option.cloneNode(true);
  filterRoleSelect.appendChild(option2);
});

// Login
function login() {
  const email = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  auth.signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('shift-section').style.display = 'block';
      document.getElementById('user-name').innerText = userCredential.user.email;
      currentUser = userCredential.user.uid; // üî• USA L'UID !!

      // Verifica se il Nome e Cognome sono gi√† salvati
      database.ref('users/' + currentUser).once('value').then(snapshot => {
        if (snapshot.exists() && snapshot.val().fullName) {
          fullName = snapshot.val().fullName;
          document.getElementById('name-form').style.display = 'none';
          document.getElementById('shift-content').style.display = 'block';
          loadShifts();
        } else {
          document.getElementById('name-form').style.display = 'block';
          document.getElementById('shift-content').style.display = 'none';
        }
      });
    })
    .catch(() => document.getElementById('error-message').innerText = "Credenziali errate. Riprova.");
}

// Salva Nome Cognome
function saveName() {
  fullName = document.getElementById('full-name').value.trim();
  if (!fullName) {
    alert("Inserisci il tuo Nome e Cognome!");
    return;
  }
  database.ref('users/' + currentUser).set({
    fullName: fullName
  }).then(() => {
    document.getElementById('name-form').style.display = 'none';
    document.getElementById('shift-content').style.display = 'block';
    loadShifts();
  });
}

// Logout
function logout() {
  auth.signOut().then(() => location.reload());
}

// Reset password
function sendResetEmail() {
  const email = document.getElementById('reset-email').value.trim();
  auth.sendPasswordResetEmail(email)
    .then(() => document.getElementById('reset-message').innerText = "Email inviata!")
    .catch(error => document.getElementById('reset-message').innerText = error.message);
}

// Cambio password
function changePassword() {
  const user = auth.currentUser;
  const oldPassword = document.getElementById('old-password').value.trim();
  const newPassword = document.getElementById('new-password').value.trim();
  const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPassword);

  user.reauthenticateWithCredential(credential)
    .then(() => user.updatePassword(newPassword).then(() => {
      document.getElementById('password-message').innerText = "Password cambiata!";
    }))
    .catch(error => document.getElementById('password-message').innerText = "Errore: " + error.message);
}

// Aggiungi o modifica turno
function addShift() {
  const date = document.getElementById('date').value;
  const startTime = document.getElementById('start-time').value;
  const endTime = document.getElementById('end-time').value;
  const role = document.getElementById('role').value;
  if (!date || !startTime || !endTime || !role) return alert('Compila tutti i campi!');

  const shift = { date, startTime, endTime, role };
  if (editingShiftId) {
    database.ref('shifts/' + currentUser + '/' + editingShiftId).set(shift).then(() => {
      editingShiftId = null;
      clearForm();
      loadShifts();
    });
  } else {
    const shiftId = database.ref().child('shifts').push().key;
    database.ref('shifts/' + currentUser + '/' + shiftId).set(shift).then(() => {
      clearForm();
      loadShifts();
    });
  }
}

// Svuota form
function clearForm() {
  document.getElementById('date').value = '';
  document.getElementById('start-time').value = '';
  document.getElementById('end-time').value = '';
  document.getElementById('role').value = '';
}
  // Carica i turni e aggiorna anche il riepilogo
function loadShifts() {
  shiftTableBody.innerHTML = '';
  summaryTableBody.innerHTML = '';

  const startDate = document.getElementById('start-date').value;
  const endDate = document.getElementById('end-date').value;
  const sortOrder = document.getElementById('sort-order').value;
  const selectedRole = document.getElementById('filter-role').value;

  database.ref('shifts/' + currentUser).once('value').then(snapshot => {
    let shifts = snapshot.val();
    if (shifts) {
      let shiftsArray = Object.entries(shifts).map(([id, shift]) => ({ id, ...shift }));

      if (startDate) shiftsArray = shiftsArray.filter(shift => new Date(shift.date) >= new Date(startDate));
      if (endDate) shiftsArray = shiftsArray.filter(shift => new Date(shift.date) <= new Date(endDate));
      if (selectedRole) shiftsArray = shiftsArray.filter(shift => shift.role === selectedRole);

      shiftsArray.sort((a, b) => sortOrder === 'asc' ? new Date(a.date) - new Date(b.date) : new Date(b.date) - new Date(a.date));

      const hoursByRole = {};

      shiftsArray.forEach(shift => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${shift.date}</td>
          <td>${shift.startTime}</td>
          <td>${shift.endTime}</td>
          <td>${shift.role}</td>
          <td>
            <button onclick="editShift('${shift.id}')">Modifica</button>
            <button onclick="deleteShift('${shift.id}')" style="background-color:red;color:white;">Elimina</button>
          </td>`;
        shiftTableBody.appendChild(row);

        const start = parseTime(shift.startTime);
        const end = parseTime(shift.endTime);
        let diffHours = (end - start) / (1000 * 60 * 60);
        if (diffHours < 0) diffHours += 24;

        if (!hoursByRole[shift.role]) hoursByRole[shift.role] = 0;
        hoursByRole[shift.role] += diffHours;
      });

      for (const role in hoursByRole) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${role}</td><td>${hoursByRole[role].toFixed(2)} ore</td>`;
        summaryTableBody.appendChild(row);
      }
    }
  });
}

// Parsing orari
function parseTime(timeStr) {
  const [hours, minutes] = timeStr.split(":").map(Number);
  const date = new Date();
  date.setHours(hours, minutes, 0, 0);
  return date;
}

// Modifica turno
function editShift(id) {
  database.ref('shifts/' + currentUser + '/' + id).once('value').then(snapshot => {
    const shift = snapshot.val();
    if (shift) {
      document.getElementById('date').value = shift.date;
      document.getElementById('start-time').value = shift.startTime;
      document.getElementById('end-time').value = shift.endTime;
      document.getElementById('role').value = shift.role;
      editingShiftId = id;
    }
  });
}

// Elimina turno
function deleteShift(id) {
  if (confirm("Sei sicuro di voler eliminare questo turno?")) {
    database.ref('shifts/' + currentUser + '/' + id).remove().then(() => loadShifts());
  }
}

// Firma Canvas
canvas.addEventListener('mousedown', () => drawing = true);
canvas.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
canvas.addEventListener('mousemove', e => {
  if (!drawing) return;
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.strokeStyle = 'black';
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});

function clearSignature() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// Esportazione PDF corretta
async function exportPDF() {
  const { jsPDF } = window.jspdf;

  const blankCanvas = document.createElement('canvas');
  blankCanvas.width = canvas.width;
  blankCanvas.height = canvas.height;
  if (canvas.toDataURL() === blankCanvas.toDataURL()) {
    alert("‚ö†Ô∏è Devi firmare prima di esportare il PDF!");
    return;
  }

  const doc = new jsPDF({
    orientation: 'landscape',
    unit: 'mm',
    format: 'a4'
  });

  const pageWidth = doc.internal.pageSize.getWidth();
  const startX = 10;
  let startY = 35; // ‚¨ÖÔ∏è Tabella pi√π in basso
  const firstColWidth = 15;
  const colWidth = 25;
  const rowHeight = 4;

  const now = new Date();
  const month = now.toLocaleString('it-IT', { month: 'long' }).toUpperCase();
  const year = now.getFullYear();

  doc.setFontSize(10);
  doc.text(`FOGLIO ORE DI ${month} ${year} - CENTRO FIN LAMPUGNANO`, 10, 10);

  doc.setFontSize(9);
  doc.text(fullName, 10, 16);

  const rows = document.querySelectorAll('#shift-table tbody tr');
  const shiftsByDateRole = {};
  const allRoles = new Set();

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const date = new Date(cells[0].innerText);
    const day = date.getDate();
    const role = cells[3].innerText;
    const start = cells[1].innerText;
    const end = cells[2].innerText;

    if (!shiftsByDateRole[day]) shiftsByDateRole[day] = {};
    shiftsByDateRole[day][role] = { start, end };
    allRoles.add(role);
  });

  const roleList = Array.from(allRoles);
  const totalWidth = firstColWidth + colWidth * roleList.length;

  // Sfondo grigio intestazione
  doc.setFillColor(230, 230, 230);
  doc.rect(startX, startY - rowHeight, totalWidth, rowHeight, 'F');

  // Intestazioni
  doc.setFontSize(7);
  doc.setTextColor(0, 0, 0);
  doc.text('Data', startX + 2, startY - 1.5);

  roleList.forEach((role, idx) => {
    const roleX = startX + firstColWidth + idx * colWidth;

    // Inseriamo un vero "a capo" (\n) tra prima e seconda parte
    if (role.includes('FERIALE') || role.includes('FESTIVO')) {
      const parts = role.split(' ');
      const firstLine = parts.slice(0, parts.length - 1).join(' ');
      const secondLine = parts[parts.length - 1];
      const combined = firstLine + '\n' + secondLine; // üî•

      doc.text(combined, roleX + (colWidth / 2), startY, {
        align: 'center',
        maxWidth: colWidth - 2
      });
    } else {
      doc.text(role, roleX + (colWidth / 2), startY, {
        align: 'center',
        maxWidth: colWidth - 2
      });
    }
});

  // ‚û°Ô∏è Corpo tabella
  let currentY = startY + rowHeight;

  const totalHoursByRole = {};

  for (let day = 1; day <= 31; day++) {
    doc.setFontSize(6);
    doc.text(day.toString(), startX + 2, currentY + 2.5);

    roleList.forEach((role, idx) => {
      const shift = shiftsByDateRole[day] ? shiftsByDateRole[day][role] : null;
      if (shift) {
        const shiftText = `${shift.start}-${shift.end}`;
        doc.text(shiftText, startX + firstColWidth + idx * colWidth + 2, currentY + 2.5);

        const [sh, sm] = shift.start.split(':').map(Number);
        const [eh, em] = shift.end.split(':').map(Number);
        let diff = (eh * 60 + em) - (sh * 60 + sm);
        if (diff < 0) diff += 24 * 60;
        const hours = diff / 60;

        if (!totalHoursByRole[role]) totalHoursByRole[role] = 0;
        totalHoursByRole[role] += hours;
      }
    });

    currentY += rowHeight;
  }

  // Totali
  doc.setFontSize(7);
  doc.text('Totali', startX + 2, currentY + 2.5);

  roleList.forEach((role, idx) => {
    const total = totalHoursByRole[role] ? totalHoursByRole[role].toFixed(2) + 'h' : '';
    doc.text(total, startX + firstColWidth + idx * colWidth + 2, currentY + 2.5);
  });

  // ‚û°Ô∏è Linee della tabella
  doc.setDrawColor(0);
  doc.setLineWidth(0.1);

  // Linee verticali
  for (let i = 0; i <= roleList.length + 1; i++) {
    const x = startX + (i === 0 ? 0 : firstColWidth + (i - 1) * colWidth);
    doc.line(x, startY - rowHeight, x, currentY + rowHeight);
  }

  // Linee orizzontali
  let lineY = startY - rowHeight;
  const totalLines = 32; // 31 giorni + 1 Totale
  for (let i = 0; i <= totalLines; i++) {
    doc.line(startX, lineY, startX + totalWidth, lineY);
    lineY += rowHeight;
  }

  // ‚û°Ô∏è Firma Collaboratore in basso fissa
  const signatureY = 200; // sempre fisso basso
  doc.setFontSize(8);
  doc.text("Firma Collaboratore:", 10, signatureY);

  const signatureImage = canvas.toDataURL("image/png");
  doc.addImage(signatureImage, 'PNG', 60, signatureY - 5, 60, 20);

  doc.setLineWidth(0.2);
  doc.rect(60, signatureY - 5, 60, 20);

  // ‚û°Ô∏è Salvataggio
  const userCleanName = firebase.auth().currentUser.email.split('@')[0].replace(/[\W_]+/g, '');
  const fileName = `FoglioOre_${userCleanName}_${month}${year}.pdf`;

  doc.save(fileName);
}
</script>
</body>
</html>
